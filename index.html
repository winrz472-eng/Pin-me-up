<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pin Me Up | Team Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.85); }
        .dark .glass { background: rgba(15, 23, 42, 0.85); }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }

        /* Task Styles & Drag n Drop */
        .task-card { transition: all 0.2s; border-left-width: 4px; cursor: grab; user-select: none; }
        .task-card:active { cursor: grabbing; }
        .task-card.dragging { opacity: 0.5; transform: scale(0.95); }

        .task-done { opacity: 0.5; text-decoration: line-through; border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .dark .task-done { background-color: #14532d !important; border-color: #22c55e !important; }

        .task-overdue { border-color: #ef4444 !important; background-color: #fef2f2 !important; animation: pulse-red 2s infinite; }
        .dark .task-overdue { background-color: #450a0a !important; border-color: #ef4444 !important; }

        .drop-zone-active {
            background-color: transparent !important;
            border: 2px dashed #f43f5e !important;
            box-shadow: none !important;
        }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        #toast-container { position: fixed; bottom: 20px; right: 20px; left: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        #toast-container > div { pointer-events: auto; margin-left: auto; }
        @media (max-width: 768px) { #toast-container > div { margin-left: 0; width: 100%; } }

        .toast { transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }

        .notification-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid white; transform: scale(0); transition: transform 0.2s; }
        .notification-badge.active { transform: scale(1); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .dark #loader { background: #0f172a; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: #f43f5e; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .animate-grid-entry { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { 0% { opacity: 0; transform: scale(0.98) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .custom-dropdown-menu { transform-origin: top right; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); transform: scale(0.95); opacity: 0; pointer-events: none; }
        .custom-dropdown-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        /* Sidebar Mobile Transition */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-overlay { transition: opacity 0.3s linear; }

        /* --- LANDING PAGE STYLES --- */
        .landing-bg {
            background-color: #0f172a;
            background-image:
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }
        .blob { position: absolute; filter: blur(80px); opacity: 0.4; animation: blob-bounce 10s infinite ease-in-out; border-radius: 50%; z-index: 0; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #f43f5e; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #8b5cf6; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #f97316; animation-delay: 4s; }

        @keyframes blob-bounce {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        .landing-content { z-index: 10; }
        .hero-btn { background-size: 200% auto; transition: 0.5s; }
        .hero-btn:hover { background-position: right center; transform: scale(1.05); box-shadow: 0 0 30px rgba(244, 63, 94, 0.5); }
        .feature-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .feature-card:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-5px); border-color: rgba(244, 63, 94, 0.3); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 overflow-hidden h-screen flex transition-colors duration-300">

    <div id="landing-screen" class="fixed inset-0 z-[250] landing-bg flex items-center justify-center hidden opacity-0 transition-opacity duration-700">
        <div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div>
        <div class="absolute top-0 left-0 w-full p-8 flex justify-between items-center z-20">
            <div class="text-white/30 font-black text-xs tracking-[0.3em] cursor-default select-none">Pin me up</div>
        </div>
        <div id="landing-main" class="landing-content text-center px-6 relative transition-all duration-500 transform scale-100 opacity-100">
             <div class="mb-8 relative inline-block group">
                <div class="absolute inset-0 bg-rose-500 rounded-full blur-xl opacity-40 group-hover:opacity-60 transition-opacity duration-500"></div>
                <img src="photo_2026-01-31_21-37-55.jpg" alt="Logo" class="w-24 h-24 mx-auto rounded-3xl relative shadow-2xl z-10 object-cover">
            </div>
            <h1 class="text-6xl md:text-8xl font-black text-white mb-2 tracking-tighter drop-shadow-sm select-none">Pin me up</h1>
            <p class="text-slate-400 text-lg md:text-xl font-medium mb-6 tracking-wide">–û—Ä–≥–∞–Ω–∏–∑—É–π —Ö–∞–æ—Å. –î–æ—Å—Ç–∏–≥–∞–π —Ü–µ–ª–µ–π.</p>
            <div class="flex justify-center mb-10">
                <button onclick="toggleFeatures()" class="text-white/60 hover:text-white font-bold text-xs uppercase tracking-widest transition-colors flex items-center gap-2 group px-4 py-2 rounded-lg hover:bg-white/5">
                    <span class="group-hover:text-rose-400 transition-colors">–§—É–Ω–∫—Ü–∏–∏</span><span class="bg-white/10 p-1 rounded group-hover:bg-rose-500/20 transition-colors">‚ú®</span>
                </button>
            </div>
            <button onclick="startExperience()" class="hero-btn bg-gradient-to-r from-rose-500 via-orange-500 to-rose-500 text-white font-black uppercase text-sm md:text-base px-10 py-5 rounded-2xl shadow-xl tracking-widest cursor-pointer">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
        </div>
        <div id="landing-features" class="landing-content absolute inset-0 flex flex-col items-center justify-center hidden opacity-0 transition-all duration-500 transform scale-95 p-6 z-30">
            <h2 class="text-4xl md:text-5xl font-black text-white mb-10 tracking-tight">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-5xl w-full">
                <div class="feature-card p-6 rounded-2xl"><div class="text-2xl mb-3">üìÜ</div><h3 class="text-white font-bold text-lg mb-1">–£–º–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h3><p class="text-slate-400 text-xs leading-relaxed">–†–µ–∂–∏–º—ã: –î–µ–Ω—å, –ù–µ–¥–µ–ª—è, –ú–µ—Å—è—Ü, –ì–æ–¥, –ì–∞–Ω—Ç.</p></div>
                <div class="feature-card p-6 rounded-2xl"><div class="text-2xl mb-3">üë•</div><h3 class="text-white font-bold text-lg mb-1">–ö–æ–º–∞–Ω–¥—ã</h3><p class="text-slate-400 text-xs leading-relaxed">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ä–æ–ª—è–º–∏.</p></div>
                <div class="feature-card p-6 rounded-2xl"><div class="text-2xl mb-3">üèÜ</div><h3 class="text-white font-bold text-lg mb-1">–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è</h3><p class="text-slate-400 text-xs leading-relaxed">–ü–æ–ª—É—á–∞–π—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥ –∑–∞ –∑–∞–¥–∞—á–∏.</p></div>
                <div class="feature-card p-6 rounded-2xl"><div class="text-2xl mb-3">üìé</div><h3 class="text-white font-bold text-lg mb-1">–§–∞–π–ª—ã –∏ –î–µ–¥–ª–∞–π–Ω—ã</h3><p class="text-slate-400 text-xs leading-relaxed">–ü—Ä–∏–∫—Ä–µ–ø–ª—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ä–æ–∫–∞–º–∏.</p></div>
                <div class="feature-card p-6 rounded-2xl"><div class="text-2xl mb-3">üåó</div><h3 class="text-white font-bold text-lg mb-1">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</h3><p class="text-slate-400 text-xs leading-relaxed">–ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–æ—á—å—é.</p></div>
                <div class="feature-card p-6 rounded-2xl"><div class="text-2xl mb-3">üñ±</div><h3 class="text-white font-bold text-lg mb-1">Drag & Drop</h3><p class="text-slate-400 text-xs leading-relaxed">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.</p></div>
            </div>
            <button onclick="toggleFeatures()" class="mt-12 text-slate-500 hover:text-white font-bold text-[10px] uppercase tracking-[0.2em] transition-colors flex items-center gap-2"><span>‚Üê –ù–∞–∑–∞–¥</span></button>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>
    <div id="toast-container"></div>

    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-900/10 backdrop-blur-xl hidden items-center justify-center p-4 transition-all duration-500">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-3xl shadow-2xl p-8 border border-slate-200 dark:border-slate-800 pointer-events-auto">
            <h2 id="auth-title" class="text-3xl font-black text-center mb-6 tracking-tight">Pin Me Up</h2>
            <div class="space-y-4">
                <input type="text" id="auth-login" placeholder="–õ–æ–≥–∏–Ω" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 font-bold transition-all">
                <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 font-bold transition-all">
                <button onclick="App.auth.handle()" id="auth-btn-main" class="w-full py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 transition-all hover:shadow-lg hover:shadow-rose-500/30">–í–æ–π—Ç–∏</button>
                <div class="flex justify-center pt-2"><button onclick="App.auth.toggleMode()" id="auth-switch-btn" class="text-xs text-slate-500 font-bold uppercase hover:text-rose-500 transition-colors">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="App.ui.toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden sidebar-overlay opacity-0"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white/95 dark:bg-slate-900/95 glass border-r border-slate-200 dark:border-slate-800 p-6 flex flex-col z-50 transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 shadow-2xl md:shadow-none h-full">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <img src="photo_2026-01-31_21-37-55.jpg" alt="Logo" class="w-10 h-10 rounded-xl shadow-lg shadow-rose-500/20 object-cover">
                <h1 class="text-2xl font-black tracking-tight uppercase bg-clip-text text-transparent bg-gradient-to-r from-rose-500 to-orange-600 drop-shadow-sm cursor-default">Pin Me Up</h1>
            </div>
            <button onclick="App.ui.toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">‚úï</button>
        </div>

        <div class="mb-6 relative group">
            <button onclick="document.getElementById('team-dropdown').classList.toggle('hidden')" class="w-full py-3 px-4 bg-slate-100 dark:bg-slate-800 rounded-xl font-bold text-xs uppercase flex justify-between items-center hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">
                <span id="current-team-name" class="truncate mr-2">–õ–∏—á–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</span><span class="text-slate-400">‚ñº</span>
            </button>
            <div id="team-dropdown" class="hidden absolute top-full left-0 w-full bg-white dark:bg-slate-800 rounded-xl shadow-xl mt-2 p-2 z-50 border border-slate-100 dark:border-slate-700 transform origin-top transition-all">
                <div id="team-list-container" class="space-y-1 max-h-48 overflow-y-auto custom-scrollbar"></div>
                <div class="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                <button onclick="App.ui.openModal('modal-create-team')" class="w-full text-left p-2 text-rose-500 text-xs font-black uppercase hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors">+ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
            </div>
        </div>

        <div class="mb-4 flex-1 overflow-hidden flex flex-col min-h-[100px]">
            <div class="flex items-center justify-between mb-4 px-1">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <button id="btn-add-teammate" onclick="App.ui.openModal('modal-invite')" class="w-6 h-6 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-500 hover:bg-rose-500 hover:text-white transition-all text-lg font-bold pb-1 hidden shadow-sm">+</button>
            </div>
            <div id="user-list" class="space-y-2 overflow-y-auto custom-scrollbar pr-2"></div>
        </div>

        <div id="leaderboard-section" class="mb-4 hidden flex-col">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1">–¢–æ–ø —Ä–µ–π—Ç–∏–Ω–≥ üèÜ</h3>
            <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-2 border border-slate-100 dark:border-slate-800 overflow-hidden">
                 <div id="leaderboard-list" class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar pr-1"></div>
            </div>
        </div>

        <div class="space-y-3 mt-auto shrink-0">
            <button onclick="App.events.openModal()" class="w-full py-3.5 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-lg shadow-rose-500/20 active:scale-95 transition-all uppercase tracking-wide text-xs">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-auto md:h-20 bg-white/50 dark:bg-slate-900/50 glass border-b border-slate-200 dark:border-slate-800 px-4 py-4 md:py-0 md:px-8 flex flex-col md:flex-row items-center justify-between z-10 shrink-0 gap-4">

            <div class="flex items-center justify-between w-full md:w-auto gap-4">
                <button onclick="App.ui.toggleSidebar()" class="md:hidden p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>

                <div class="flex items-center gap-2 md:gap-3">
                     <button onclick="App.calendar.navigate(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all text-sm font-bold shadow-sm">‚Üê</button>
                     <button onclick="App.calendar.navigate(1)" class="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all text-sm font-bold shadow-sm">‚Üí</button>
                </div>
                <h2 id="current-date-display" class="text-lg md:text-xl font-black tracking-tight min-w-[140px] text-center md:text-left"></h2>
            </div>

            <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                <div class="relative z-30">
                    <button id="view-btn" onclick="App.ui.toggleViewDropdown()" class="flex items-center justify-between gap-3 bg-slate-100 dark:bg-slate-800 font-bold text-xs uppercase px-4 py-2.5 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <span id="current-view-label">–ú–µ—Å—è—Ü</span>
                        <svg class="w-3 h-3 text-slate-400 transition-transform duration-200" id="view-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="view-dropdown" class="custom-dropdown-menu absolute right-0 top-full mt-2 w-36 bg-white dark:bg-slate-900 rounded-xl shadow-2xl border border-slate-100 dark:border-slate-800 p-1.5 overflow-hidden">
                        <button onclick="App.calendar.switchView('gantt')" class="w-full text-left px-3 py-2 rounded-lg text-xs font-bold uppercase hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors border-t border-slate-100 dark:border-slate-800 mt-1 pt-2">–ì–∞–Ω—Ç</button>
                        <button onclick="App.calendar.switchView('day')" class="w-full text-left px-3 py-2 rounded-lg text-xs font-bold uppercase hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors mb-0.5">–î–µ–Ω—å</button>
                        <button onclick="App.calendar.switchView('week')" class="w-full text-left px-3 py-2 rounded-lg text-xs font-bold uppercase hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors mb-0.5">–ù–µ–¥–µ–ª—è</button>
                        <button onclick="App.calendar.switchView('month')" class="w-full text-left px-3 py-2 rounded-lg text-xs font-bold uppercase hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors mb-0.5">–ú–µ—Å—è—Ü</button>
                        <button onclick="App.calendar.switchView('year')" class="w-full text-left px-3 py-2 rounded-lg text-xs font-bold uppercase hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors">–ì–æ–¥</button>
                    </div>
                </div>

                <div class="relative">
                    <button onclick="App.ui.toggleNotifications()" class="p-2.5 bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:text-rose-500 transition-colors relative border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <div id="notif-badge" class="notification-badge"></div>
                    </button>
                    <div id="notif-dropdown" class="hidden absolute right-0 top-full mt-4 w-72 md:w-80 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-800 z-50 overflow-hidden transform origin-top-right transition-all">
                        <div class="p-3 border-b dark:border-slate-800 font-black text-[10px] uppercase text-slate-400 bg-slate-50 dark:bg-slate-900/50 flex justify-between">
                            <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                            <button onclick="App.notifications.clearAll()" class="hover:text-rose-500 transition-colors">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                        <div id="notif-list" class="max-h-64 overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
                    </div>
                </div>

                <div class="flex items-center gap-4 pl-0 md:pl-6 border-l-0 md:border-l border-slate-200 dark:border-slate-800">
                    <div class="text-right hidden md:block">
                        <p id="display-user-name" class="text-sm font-black leading-none mb-1"></p>
                        <p id="display-role" class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">User</p>
                    </div>
                    <img id="display-user-avatar" onclick="App.ui.openModal('modal-settings')" class="w-10 h-10 rounded-xl border-2 border-white dark:border-slate-700 shadow-md object-cover bg-slate-200 cursor-pointer hover:scale-105 transition-transform">
                </div>
            </div>
        </header>

        <div class="flex-1 p-2 md:p-6 overflow-y-auto bg-slate-50/50 dark:bg-slate-950/50 custom-scrollbar relative" id="calendar-container">
            <div id="calendar-grid"></div>
        </div>
    </main>

    <div id="modal-create-team" class="modal-overlay fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="modal-content bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] shadow-2xl p-8 border dark:border-slate-800">
            <h3 class="text-xl font-black mb-4">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</h3>
            <input type="text" id="new-team-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none font-bold mb-4 focus:ring-2 focus:ring-rose-500 transition-all">
            <div class="flex gap-3"><button onclick="App.ui.closeModal('modal-create-team')" class="flex-1 py-3 text-slate-400 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">–û—Ç–º–µ–Ω–∞</button><button onclick="App.teams.create()" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 transition-colors shadow-lg shadow-rose-500/20">–°–æ–∑–¥–∞—Ç—å</button></div>
        </div>
    </div>
    <div id="modal-invite" class="modal-overlay fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="modal-content bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] shadow-2xl p-8 border dark:border-slate-800">
             <h3 class="text-xl font-black mb-2">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</h3><p class="text-xs text-slate-500 mb-4 font-medium">–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
             <input type="text" id="invite-login" placeholder="–õ–æ–≥–∏–Ω –∏–ª–∏ ID (#XXXXXX)" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none font-bold mb-4 focus:ring-2 focus:ring-rose-500 transition-all">
             <div class="flex gap-3"><button onclick="App.ui.closeModal('modal-invite')" class="flex-1 py-3 text-slate-400 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">–û—Ç–º–µ–Ω–∞</button><button onclick="App.teams.invite()" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 transition-colors shadow-lg shadow-rose-500/20">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button></div>
        </div>
    </div>
    <div id="modal-event" class="modal-overlay fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="modal-content bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] shadow-2xl p-6 md:p-8 border dark:border-slate-800 relative max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-start mb-6"><h3 class="text-2xl font-black text-rose-500 italic" id="modal-event-title">–ó–∞–¥–∞—á–∞</h3><button id="btn-delete-event" onclick="App.events.delete()" class="text-slate-400 hover:text-red-500 transition-colors hidden"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>
            <div class="space-y-4">
                <div><label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="event-name" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none font-bold focus:ring-2 focus:ring-rose-500 transition-all"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">–î–∞—Ç–∞</label><input type="date" id="event-full-date" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none font-bold text-sm focus:ring-2 focus:ring-rose-500 transition-all text-slate-600 dark:text-slate-300"></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">–í—Ä–µ–º—è</label><input type="time" id="event-time" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl outline-none font-bold text-sm focus:ring-2 focus:ring-rose-500 transition-all text-slate-600 dark:text-slate-300"></div>
                </div>
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                    <span class="text-xs font-black uppercase text-slate-500">–°—Ç–∞—Ç—É—Å</span>
                    <button id="btn-status-toggle" onclick="App.events.toggleStatusUI()" class="px-4 py-2 rounded-lg text-xs font-bold transition-all bg-slate-200 text-slate-500 hover:bg-slate-300">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</button>
                </div>
                <div id="recurrence-block" class="mb-4 hidden">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</label>
                    <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                        <button onclick="App.events.setRecurrence('none')" id="rec-btn-none" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm">–ù–µ—Ç</button>
                        <button onclick="App.events.setRecurrence('daily')" id="rec-btn-daily" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å</button>
                        <button onclick="App.events.setRecurrence('weekly')" id="rec-btn-weekly" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400">–ù–µ–¥–µ–ª—é</button>
                    </div>
                    <input type="hidden" id="event-recurrence" value="none">
                </div>
                <div class="pt-2" id="participants-block"><p class="text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞</p><div id="modal-users" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar pr-2"></div></div>
                <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 relative transition-all hover:border-rose-400">
                    <div id="file-upload-ui" class="text-center py-2">
                        <p class="text-[10px] uppercase font-black text-slate-400 mb-2">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</p>
                        <button onclick="document.getElementById('event-file-input').click()" class="text-xs font-bold text-rose-500 hover:text-rose-600 transition-colors flex items-center justify-center gap-2 w-full"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                    </div>
                    <div id="file-display-ui" class="hidden flex items-center justify-between bg-white dark:bg-slate-900 p-2 rounded-lg shadow-sm border border-slate-100 dark:border-slate-700">
                        <a id="file-download-link" href="#" download class="flex items-center gap-2 text-xs font-bold text-slate-700 dark:text-slate-300 hover:text-rose-500 truncate max-w-[200px] transition-colors group"><div class="p-1.5 bg-rose-100 text-rose-500 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></div><span id="file-name-display" class="truncate">filename.pdf</span></a><button onclick="App.events.removeFile()" class="text-slate-400 hover:text-red-500 p-1.5 transition-colors">‚úï</button>
                    </div>
                    <input type="file" id="event-file-input" class="hidden" onchange="App.events.handleFileUpload(this)">
                </div>
                 <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <div class="relative flex items-center"><input type="checkbox" id="event-has-deadline" onchange="App.events.toggleDeadlineUI()" class="peer appearance-none w-5 h-5 border-2 border-slate-300 dark:border-slate-600 rounded checked:bg-red-500 checked:border-red-500 transition-colors"><svg class="absolute w-3 h-3 text-white hidden peer-checked:block pointer-events-none left-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
                        <span class="text-xs font-black uppercase text-slate-400 group-hover:text-red-500 transition-colors">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω</span>
                    </label>
                    <div id="deadline-inputs" class="hidden mt-3 grid grid-cols-2 gap-4 bg-red-50 dark:bg-red-900/10 p-3 rounded-xl border border-red-100 dark:border-red-900/30">
                        <div><label class="text-[9px] font-black text-red-400 uppercase ml-2 mb-1 block">–î–∞—Ç–∞</label><input type="date" id="deadline-date" class="w-full px-3 py-2 bg-white dark:bg-slate-900 rounded-lg outline-none font-bold text-xs focus:ring-2 focus:ring-red-500 transition-all text-slate-600 dark:text-slate-300"></div>
                        <div><label class="text-[9px] font-black text-red-400 uppercase ml-2 mb-1 block">–í—Ä–µ–º—è</label><input type="time" id="deadline-time" class="w-full px-3 py-2 bg-white dark:bg-slate-900 rounded-lg outline-none font-bold text-xs focus:ring-2 focus:ring-red-500 transition-all text-slate-600 dark:text-slate-300"></div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="App.ui.closeModal('modal-event')" class="flex-1 py-3 text-slate-400 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors">–û—Ç–º–µ–Ω–∞</button><button onclick="App.events.save()" class="flex-1 py-3 bg-rose-500 text-white font-bold rounded-xl shadow-lg shadow-rose-500/20 hover:bg-rose-600 hover:shadow-rose-500/40 transition-all">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
    </div>
    <div id="modal-view-profile" class="modal-overlay fixed inset-0 z-[200] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] shadow-2xl p-8 border dark:border-slate-800 flex flex-col items-center"><div class="w-full flex justify-end mb-2"><button onclick="App.ui.closeModal('modal-view-profile')" class="text-slate-400 hover:text-slate-600">‚úï</button></div><img id="view-profile-avatar" src="" class="w-24 h-24 rounded-3xl object-cover border-4 border-slate-100 dark:border-slate-800 shadow-sm mb-4"><h3 id="view-profile-name" class="text-2xl font-black text-center mb-1"></h3><p id="view-profile-uid" class="text-xs font-bold text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-lg cursor-pointer hover:text-rose-500 transition-colors" onclick="App.utils.copyId(this)" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"></p></div></div>
    <div id="modal-settings" class="modal-overlay fixed inset-0 z-[200] flex items-center justify-center p-4"><div class="modal-content bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] shadow-2xl p-8 border dark:border-slate-800"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3> <button onclick="App.ui.closeModal('modal-settings')" class="text-slate-400 hover:text-slate-600">‚úï</button></div><div class="mb-8"><p class="text-[10px] font-black text-slate-400 uppercase mb-2 text-center tracking-widest">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</p><div class="p-1 bg-slate-100 dark:bg-slate-800 rounded-xl flex"><button onclick="App.ui.setTheme('light')" id="theme-btn-light" class="flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all">–°–≤–µ—Ç–ª–∞—è</button><button onclick="App.ui.setTheme('dark')" id="theme-btn-dark" class="flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all">–¢–µ–º–Ω–∞—è</button></div></div><div class="flex flex-col items-center mb-8"><div class="relative group cursor-pointer"><img id="settings-avatar" onclick="document.getElementById('profile-upload').click()" class="w-24 h-24 rounded-3xl object-cover border-4 border-slate-100 dark:border-slate-800 shadow-sm mb-4 transition-opacity group-hover:opacity-80"><div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none text-white font-bold text-xs">–ò–∑–º–µ–Ω–∏—Ç—å</div></div><input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="App.auth.uploadAvatar(this)"><input type="text" id="settings-name" class="text-center font-black text-xl bg-transparent border-b-2 border-transparent hover:border-slate-200 focus:border-rose-500 outline-none w-full pb-1 transition-colors" placeholder="–í–∞—à–µ –∏–º—è"><div class="flex items-center justify-center gap-2 mt-1"><p id="settings-user-uid" class="text-xs font-bold text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-lg cursor-pointer hover:text-rose-500 transition-colors" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" onclick="App.utils.copyId(this)">ID: ---</p></div></div><div class="space-y-3"><button onclick="App.auth.saveProfile()" class="w-full py-3.5 bg-slate-900 dark:bg-slate-100 dark:text-slate-900 text-white rounded-xl text-xs font-black uppercase hover:shadow-lg transition-all">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button onclick="App.auth.logout()" class="w-full py-3.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl text-xs font-bold transition-colors">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button></div></div></div>

    <div id="team-context-menu" class="hidden fixed z-[100] bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-100 dark:border-slate-700 overflow-hidden w-40 py-1"><button id="ctx-btn-delete-team" onclick="App.teams.delete()" class="w-full text-left px-4 py-2.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-xs font-bold transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> –£–¥–∞–ª–∏—Ç—å</button><button id="ctx-btn-leave-team" onclick="App.teams.leave()" class="hidden w-full text-left px-4 py-2.5 text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 text-xs font-bold transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> –í—ã–π—Ç–∏</button></div>
    <div id="user-context-menu" class="hidden fixed z-[100] bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-100 dark:border-slate-700 overflow-hidden w-48 py-1"><button onclick="App.teams.viewUserProfile()" class="w-full text-left px-4 py-2.5 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 text-xs font-bold transition-colors flex items-center gap-2 border-b border-slate-50 dark:border-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> –ü—Ä–æ—Ñ–∏–ª—å</button><button id="btn-remove-user" onclick="App.teams.removeMember()" class="w-full text-left px-4 py-2.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-xs font-bold transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" /></svg> –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ–º–∞–Ω–¥—ã</button></div>

   <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBBgjvfz34xrwZ07P7MHQQwwAaY6TLxCEw",
          authDomain: "pin-me-up.firebaseapp.com",
          databaseURL: "https://pin-me-up-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "pin-me-up",
          storageBucket: "pin-me-up.firebasestorage.app",
          messagingSenderId: "1076332865985",
          appId: "1:1076332865985:web:a2397bc279c1d12c10a740",
          measurementId: "G-F5TJT9DS68"
        };

        let db;

        // Toggle Function for Features
        function toggleFeatures() {
            const main = document.getElementById('landing-main');
            const feat = document.getElementById('landing-features');

            if (feat.classList.contains('hidden')) {
                main.style.opacity = '0'; main.style.transform = 'scale(0.9)'; setTimeout(() => main.classList.add('hidden'), 300);
                feat.classList.remove('hidden'); setTimeout(() => { feat.style.opacity = '1'; feat.style.transform = 'scale(1)'; }, 50);
            } else {
                feat.style.opacity = '0'; feat.style.transform = 'scale(0.95)'; setTimeout(() => feat.classList.add('hidden'), 300);
                main.classList.remove('hidden'); setTimeout(() => { main.style.opacity = '1'; main.style.transform = 'scale(1)'; }, 50);
            }
        }

        function startExperience() {
            const landing = document.getElementById('landing-screen');
            landing.style.opacity = '0';
            setTimeout(() => {
                landing.style.display = 'none';
                App.ui.openModal('auth-screen');
            }, 700);
        }

        function initApp() {
            if (!firebaseConfig.apiKey) { alert("–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á–∏ Firebase!"); return; }
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();

            const storedUser = localStorage.getItem('pin_v2_session');
            if (storedUser) {
                Store.session.user = JSON.parse(storedUser);
                Store.connectDB();
            } else {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    const landing = document.getElementById('landing-screen');
                    landing.classList.remove('hidden');
                    setTimeout(() => landing.style.opacity = '1', 50);
                }, 500);
            }

            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        const Utils = {
            escapeHtml: (text) => text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '',
            formatDateForInput: (dateObj) => {
                const y = dateObj.getFullYear();
                const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                const d = String(dateObj.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            },
            generateId: () => Date.now() + Math.floor(Math.random() * 1000),
            generateUid: () => '#' + Math.random().toString(36).substr(2, 6).toUpperCase(),

            getWeekStart: (d) => {
                const date = new Date(d);
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(date.setDate(diff));
            },
            areDatesEqual: (d1, d2) => d1.getDate() === d2.getDate() && d1.getMonth() === d2.getMonth() && d1.getFullYear() === d2.getFullYear(),

            isEventVisible: (ev, targetDate) => {
                const start = new Date(ev.dateStr); start.setHours(0,0,0,0);
                const target = new Date(targetDate); target.setHours(0,0,0,0);
                if (target < start) return false;
                if (ev.deadline) {
                    const deadlineDate = new Date(ev.deadline.date); deadlineDate.setHours(0,0,0,0);
                    if (target > deadlineDate) return false;
                }
                if (!ev.recurrence || ev.recurrence === 'none') return start.getTime() === target.getTime();
                if (ev.recurrence === 'daily') return true;
                if (ev.recurrence === 'weekly') return start.getDay() === target.getDay();
                if (ev.recurrence === 'monthly') return start.getDate() === target.getDate();
                return false;
            },
            isEventCompleted: (ev, dateStr) => {
                if (!ev.recurrence || ev.recurrence === 'none') return ev.completed;
                return (ev.completedDates || []).includes(dateStr);
            }
        };

        const Store = {
            data: { users: [], teams: [], events: [], notifications: [] },
            session: { user: null, activeTeamId: localStorage.getItem('pin_v2_active_team') || 'personal', currentDate: new Date(), view: 'month', currentEventId: null, tempAvatar: "", tempFile: null, contextDateStr: null },
            connectDB() {
                db.ref('/').on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        this.data.users = val.users || []; this.data.teams = val.teams || []; this.data.events = val.events || []; this.data.notifications = val.notifications || [];
                        const currentUserIdx = this.data.users.findIndex(u => u.id === this.session.user.id);
                        if (currentUserIdx !== -1 && !this.data.users[currentUserIdx].uid) {
                            const newUid = Utils.generateUid();
                            this.data.users[currentUserIdx].uid = newUid; this.session.user.uid = newUid;
                            localStorage.setItem('pin_v2_session', JSON.stringify(this.session.user)); this.save();
                        } else if (currentUserIdx !== -1) {
                            this.session.user.uid = this.data.users[currentUserIdx].uid;
                        }
                    } else { this.save(); }
                    document.getElementById('loader').style.display = 'none'; App.ui.closeModal('auth-screen'); App.ui.refresh();
                });
                setInterval(() => App.notifications.checkDeadlines(), 60000);
            },
            save() { db.ref('/').set(this.data); },
            getActiveTeam() { return this.session.activeTeamId === 'personal' ? null : this.data.teams.find(t => t.id == this.session.activeTeamId); },
            getFilteredEvents() {
                return (this.data.events || []).filter(e => {
                     const isCorrectContext = this.session.activeTeamId === 'personal' ? (e.context === 'personal' && e.creatorId === this.session.user.id) : (e.context === 'team' && e.teamId == this.session.activeTeamId);
                     if (!isCorrectContext) return false;
                     if (this.session.activeTeamId === 'personal') return true;
                     const team = this.getActiveTeam(); const userId = this.session.user.id;
                     if (team && team.ownerId === userId) return true;
                     if (e.assignees && e.assignees.includes(userId)) return true;
                     return false;
                });
            }
        };

        const App = {
            utils: {
                copyId(el) {
                    const text = el.innerText.replace('ID: ', '');
                    navigator.clipboard.writeText(text).then(() => {
                        const original = el.innerText; el.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"; el.classList.add('text-green-500');
                        setTimeout(() => { el.innerText = original; el.classList.remove('text-green-500'); }, 1500);
                    });
                }
            },
            drag: {
                draggedEvent: null,
                handleDragStart(e, eventObj) {
                    this.draggedEvent = eventObj; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', JSON.stringify(eventObj)); setTimeout(() => e.target.classList.add('dragging'), 0);
                },
                handleDragEnd(e) { e.target.classList.remove('dragging'); this.draggedEvent = null; document.querySelectorAll('.drop-zone-active').forEach(el => el.classList.remove('drop-zone-active')); },
                handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drop-zone-active'); },
                handleDragLeave(e) { e.currentTarget.classList.remove('drop-zone-active'); },
                handleDrop(e, newDate, newTime) {
                    e.preventDefault(); e.currentTarget.classList.remove('drop-zone-active');
                    if (!this.draggedEvent) return;
                    const ev = this.draggedEvent; ev.dateStr = Utils.formatDateForInput(newDate); if(newTime) ev.time = newTime;
                    const idx = Store.data.events.findIndex(x => x.id === ev.id);
                    if(idx !== -1) { Store.data.events[idx] = ev; Store.save(); App.ui.showToast('–ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞', 'success'); }
                }
            },
            ui: {
                toggleSidebar() {
                    const sb = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    const isClosed = sb.classList.contains('-translate-x-full');
                    if(isClosed) {
                        sb.classList.remove('-translate-x-full');
                        overlay.classList.remove('hidden');
                        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                    } else {
                        sb.classList.add('-translate-x-full');
                        overlay.classList.add('opacity-0');
                        setTimeout(() => overlay.classList.add('hidden'), 300);
                    }
                },
                toggleViewDropdown() {
                    const drop = document.getElementById('view-dropdown'); const chev = document.getElementById('view-chevron');
                    const isActive = drop.classList.contains('active');
                    if (isActive) { drop.classList.remove('active'); chev.style.transform = 'rotate(0deg)'; } else { drop.classList.add('active'); chev.style.transform = 'rotate(180deg)'; }
                },
                closeViewDropdown() {
                    const drop = document.getElementById('view-dropdown'); const chev = document.getElementById('view-chevron');
                    if(drop) { drop.classList.remove('active'); chev.style.transform = 'rotate(0deg)'; }
                },
                setTheme(mode) {
                    if (mode === 'dark') { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } this.updateThemeBtns();
                },
                updateThemeBtns() {
                    const isDark = document.documentElement.classList.contains('dark'); const btnLight = document.getElementById('theme-btn-light'); const btnDark = document.getElementById('theme-btn-dark');
                    if (!btnLight) return;
                    const active = "bg-white dark:bg-slate-700 text-rose-500 shadow-sm"; const inactive = "text-slate-400 hover:text-slate-600 dark:hover:text-slate-200";
                    btnLight.className = `flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${!isDark ? active : inactive}`;
                    btnDark.className = `flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${isDark ? active : inactive}`;
                },
                showToast(msg, type = 'info') {
                    const container = document.getElementById('toast-container'); const toast = document.createElement('div');
                    let bgClass = type === 'alert' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-slate-800');
                    if(document.documentElement.classList.contains('dark') && type === 'info') bgClass = 'bg-white text-slate-900';
                    toast.className = `toast p-4 rounded-xl text-white shadow-xl flex items-center gap-3 min-w-[300px] text-sm font-bold ${bgClass}`;
                    toast.innerHTML = `<span>${msg}</span>`; container.appendChild(toast);
                    requestAnimationFrame(() => toast.classList.add('show'));
                    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3500);
                },
                openModal(id) {
                    const modal = document.getElementById(id); modal.style.display = 'flex'; requestAnimationFrame(() => modal.classList.add('active'));
                    if(id === 'modal-create-team') document.getElementById('team-dropdown').classList.add('hidden');
                    if(id === 'modal-settings' && Store.session.user) {
                        document.getElementById('settings-name').value = Store.session.user.name; document.getElementById('settings-avatar').src = Store.session.user.avatar;
                        const uid = Store.session.user.uid || "---"; document.getElementById('settings-user-uid').innerText = `ID: ${uid}`;
                    }
                },
                closeModal(id) { const modal = document.getElementById(id); modal.classList.remove('active'); setTimeout(() => modal.style.display = 'none', 300); },
                toggleNotifications() {
                    const dropdown = document.getElementById('notif-dropdown'); dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        const myNotifs = Store.data.notifications.filter(n => n.to === Store.session.user.id);
                        const list = document.getElementById('notif-list');
                        if (myNotifs.length === 0) list.innerHTML = '<div class="text-center text-xs text-slate-400 p-6 italic">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                        else {
                            list.innerHTML = myNotifs.map(n => `<div class="p-3 rounded-xl ${n.read ? 'opacity-50' : 'bg-slate-50 dark:bg-slate-800 border-l-2 border-rose-500'} mb-1 text-xs transition-all"><div class="font-bold ${n.type === 'alert' ? 'text-red-500' : 'dark:text-white'}">${Utils.escapeHtml(n.msg)}</div><div class="text-[9px] text-slate-400 text-right mt-1">${n.date}</div></div>`).join('');
                            let changed = false; Store.data.notifications.forEach(n => { if(n.to === Store.session.user.id && !n.read) { n.read = true; changed = true; } });
                            if(changed) { Store.save(); App.notifications.updateBadge(); }
                        }
                    }
                },
                renderLeaderboard() {
                    const team = Store.getActiveTeam(); const section = document.getElementById('leaderboard-section');
                    if (!team) { section.classList.add('hidden'); section.classList.remove('flex'); return; }
                    section.classList.remove('hidden'); section.classList.add('flex');
                    const members = (Store.data.users || []).filter(u => team.members.includes(u.id));
                    const teamRatings = team.ratings || {};
                    members.sort((a, b) => (teamRatings[b.id] || 0) - (teamRatings[a.id] || 0));
                    const list = document.getElementById('leaderboard-list');
                    list.innerHTML = members.map((u, index) => {
                        let medal = ''; if (index === 0) medal = 'ü•á'; else if (index === 1) medal = 'ü•à'; else if (index === 2) medal = 'ü•â'; else medal = `<span class="text-slate-400 text-[9px] font-bold w-4 text-center">${index + 1}</span>`;
                        const score = teamRatings[u.id] || 0;
                        return `<div class="flex items-center justify-between p-1.5 rounded-lg hover:bg-white dark:hover:bg-slate-700 transition-colors"><div class="flex items-center gap-2 overflow-hidden"><div class="shrink-0 w-4 flex justify-center">${medal}</div><img src="${u.avatar}" class="w-5 h-5 rounded-full object-cover"><span class="text-[10px] font-bold truncate max-w-[80px]">${Utils.escapeHtml(u.name)}</span></div><span class="text-[10px] font-black text-rose-500">${score}</span></div>`;
                    }).join('');
                },
                refresh() {
                    const team = Store.getActiveTeam(); const user = Store.session.user; if(!user) return;
                    document.getElementById('current-team-name').innerText = team ? team.name : "–õ–∏—á–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å";
                    document.getElementById('display-user-name').innerText = user.name; document.getElementById('display-user-avatar').src = user.avatar;
                    const isOwner = team && team.ownerId === user.id;
                    document.getElementById('display-role').innerText = team ? (isOwner ? "Admin" : "Member") : "Personal";
                    const btnAdd = document.getElementById('btn-add-teammate'); if (team && isOwner) btnAdd.classList.remove('hidden'); else btnAdd.classList.add('hidden');
                    const myTeams = (Store.data.teams || []).filter(t => t.members && t.members.includes(user.id));
                    const listContainer = document.getElementById('team-list-container'); listContainer.innerHTML = '';
                    const createBtnEl = (id, name, isPersonal) => {
                        const btn = document.createElement('button'); const isActive = Store.session.activeTeamId == id;
                        btn.className = `w-full text-left p-2 rounded-lg text-xs font-bold hover:bg-slate-100 dark:hover:bg-slate-700 ${isActive ? 'text-rose-500 bg-slate-50 dark:bg-slate-800' : 'text-slate-600 dark:text-slate-300'} transition-colors`;
                        btn.innerText = Utils.escapeHtml(name); btn.onclick = () => App.teams.switch(id);
                        if(!isPersonal) btn.oncontextmenu = (e) => App.teams.showContextMenu(e, id);
                        return btn;
                    };
                    listContainer.appendChild(createBtnEl('personal', '–õ–∏—á–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å', true));
                    myTeams.forEach(t => listContainer.appendChild(createBtnEl(t.id, t.name, false)));
                    const members = team ? (Store.data.users || []).filter(u => team.members.includes(u.id)) : [user];
                    const userListContainer = document.getElementById('user-list'); userListContainer.innerHTML = '';
                    members.forEach(u => {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800/50 transition-colors group cursor-default";
                        div.innerHTML = `<img src="${u.avatar}" class="w-8 h-8 rounded-full object-cover shadow-sm"><span class="text-xs font-bold truncate text-slate-700 dark:text-slate-300">${Utils.escapeHtml(u.name)} ${u.id === user.id ? '<span class="text-slate-400 font-normal">(–í—ã)</span>' : ''}</span>${team && team.ownerId === u.id ? '<span class="ml-auto text-[9px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-black">BOSS</span>' : ''}`;
                        if (team && u.id !== user.id) div.oncontextmenu = (e) => App.teams.showUserContextMenu(e, u.id);
                        userListContainer.appendChild(div);
                    });
                    this.renderLeaderboard(); App.notifications.updateBadge(); App.calendar.render();
                }
            },
            auth: {
                isLoginMode: true,
                toggleMode() { this.isLoginMode = !this.isLoginMode; document.getElementById('auth-title').innerText = this.isLoginMode ? 'Pin Me Up' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'; document.getElementById('auth-btn-main').innerText = this.isLoginMode ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'; document.getElementById('auth-switch-btn').innerText = this.isLoginMode ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?' : '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?'; },
                handle() {
                    const login = document.getElementById('auth-login').value.trim(); const pass = document.getElementById('auth-pass').value.trim();
                    if(!login || !pass) return App.ui.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "alert");
                    const loader = document.getElementById('loader'); loader.style.display = 'flex'; loader.style.opacity = '1';
                    db.ref('users').once('value').then((snapshot) => {
                        const val = snapshot.val(); const users = val ? Object.values(val) : [];
                        loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 300);
                        if (this.isLoginMode) {
                            const user = users.find(u => u.name.toLowerCase() === login.toLowerCase() && u.password === pass);
                            if (user) this.success(user); else App.ui.showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "alert");
                        } else {
                            if (users.some(u => u.name.toLowerCase() === login.toLowerCase())) return App.ui.showToast("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç", "alert");
                            const newUser = { id: Utils.generateId(), name: login, password: pass, avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=" + login, uid: Utils.generateUid() };
                            users.push(newUser); db.ref('users').set(users); this.success(newUser);
                        }
                    }).catch(error => { loader.style.display = 'none'; App.ui.showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "alert"); });
                },
                success(user) { Store.session.user = user; localStorage.setItem('pin_v2_session', JSON.stringify(user)); Store.connectDB(); },
                logout() { localStorage.removeItem('pin_v2_session'); localStorage.removeItem('pin_v2_active_team'); location.reload(); },
                uploadAvatar(input) {
                    const file = input.files[0]; if(!file) return; if(file.size > 2000000) return App.ui.showToast("–§–∞–π–ª > 2MB", "alert");
                    const r = new FileReader(); r.onload = e => { document.getElementById('settings-avatar').src = e.target.result; Store.session.tempAvatar = e.target.result; }; r.readAsDataURL(file);
                },
                saveProfile() {
                    const name = document.getElementById('settings-name').value.trim(); if(name) Store.session.user.name = name;
                    if(Store.session.tempAvatar) Store.session.user.avatar = Store.session.tempAvatar;
                    const idx = Store.data.users.findIndex(u => u.id === Store.session.user.id); if(idx !== -1) Store.data.users[idx] = Store.session.user;
                    Store.save(); localStorage.setItem('pin_v2_session', JSON.stringify(Store.session.user)); App.ui.closeModal('modal-settings'); App.ui.showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω", "success");
                }
            },
            calendar: {
                MONTHS: ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"],
                switchView(viewName) {
                    Store.session.view = viewName; const labels = { 'day': '–î–µ–Ω—å', 'week': '–ù–µ–¥–µ–ª—è', 'month': '–ú–µ—Å—è—Ü', 'year': '–ì–æ–¥', 'gantt': '–ì–∞–Ω—Ç' };
                    const labelEl = document.getElementById('current-view-label'); if(labelEl) labelEl.innerText = labels[viewName]; App.ui.closeViewDropdown(); this.render();
                },
                navigate(step) {
                    const d = Store.session.currentDate; const view = Store.session.view;
                    if (view === 'day') d.setDate(d.getDate() + step); else if (view === 'week') d.setDate(d.getDate() + (step * 7)); else if (view === 'month' || view === 'gantt') d.setMonth(d.getMonth() + step); else if (view === 'year') d.setFullYear(d.getFullYear() + step);
                    Store.session.currentDate = new Date(d); this.render();
                },
                createEventCard(ev, dateContext) {
                    const isDone = Utils.isEventCompleted(ev, Utils.formatDateForInput(dateContext)); const isOverdue = ev.overdue;
                    let baseClass = "p-1.5 text-left relative z-10 task-card shadow-sm text-[10px] rounded mb-1 truncate ";
                    if (isDone) baseClass += "task-done bg-slate-50 dark:bg-slate-800 text-slate-400 border-l-2 border-green-500 "; else if (ev.pendingReview) baseClass += "bg-amber-50 dark:bg-amber-900/20 text-amber-800 dark:text-amber-200 border-l-2 border-amber-500 "; else if (isOverdue) baseClass += "task-overdue bg-red-50 dark:bg-red-900/30 text-red-900 dark:text-red-200 border-l-2 border-red-500 "; else baseClass += Store.session.activeTeamId === 'personal' ? "bg-indigo-50 dark:bg-indigo-900/30 border-l-2 border-indigo-500 text-indigo-900 dark:text-indigo-200 " : "bg-rose-50 dark:bg-rose-900/30 border-l-2 border-rose-500 text-rose-900 dark:text-rose-200 ";
                    const div = document.createElement('div'); div.className = baseClass; div.setAttribute('draggable', 'true'); div.ondragstart = (e) => App.drag.handleDragStart(e, ev); div.ondragend = (e) => App.drag.handleDragEnd(e);
                    let icon = ""; if(ev.pendingReview && !isDone) icon = "‚è≥ ";
                    let content = `<span class="font-black mr-1">${ev.time}</span> ${icon}${Utils.escapeHtml(ev.title)}`;
                    if (ev.deadline && !isDone && !ev.pendingReview) content += ` <span class="ml-1 text-[9px] font-bold text-red-500" title="–î–µ–¥–ª–∞–π–Ω: ${ev.deadline.date} ${ev.deadline.time}">üî•</span>`;
                    div.innerHTML = content; div.onclick = (e) => { e.stopPropagation(); App.events.openModal(dateContext, ev); };
                    return div;
                },
                render() {
                    const view = Store.session.view; const grid = document.getElementById('calendar-grid'); grid.innerHTML = ''; grid.className = 'animate-grid-entry';
                    if (view === 'month') this.renderMonth(grid); else if (view === 'week') this.renderWeek(grid); else if (view === 'day') this.renderDay(grid); else if (view === 'year') this.renderYear(grid); else if (view === 'gantt') this.renderGantt(grid);
                },
                renderGantt(grid) { /* GANTT CODE OMITTED (Unchanged Logic, just container adaptation handled by CSS) */
                    const d = Store.session.currentDate;
                    document.getElementById('current-date-display').innerText = `${this.MONTHS[d.getMonth()]} ${d.getFullYear()} (–ì–∞–Ω—Ç)`;
                    grid.className = "bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden h-full max-h-[calc(100vh-200px)]";
                    // ... (rest of gantt logic is fine, just ensure overflow works)
                    const year = d.getFullYear(); const month = d.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const dayWidth = 40;
                    const header = document.createElement('div'); header.className = "flex border-b border-slate-200 dark:border-slate-800 shrink-0 overflow-hidden";
                    const titleSpacer = document.createElement('div'); titleSpacer.className = "w-64 shrink-0 p-4 border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 font-bold text-xs uppercase text-slate-400"; titleSpacer.innerText = "–ó–∞–¥–∞—á–∞"; header.appendChild(titleSpacer);
                    const daysContainer = document.createElement('div'); daysContainer.className = "flex overflow-hidden relative";
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayCol = document.createElement('div'); const isToday = Utils.areDatesEqual(new Date(year, month, i), new Date());
                        dayCol.style.width = `${dayWidth}px`; dayCol.className = `shrink-0 text-center py-3 border-r border-slate-100 dark:border-slate-800 text-[10px] font-bold ${isToday ? 'bg-rose-50 text-rose-500' : 'text-slate-400'}`;
                        dayCol.innerText = i; daysContainer.appendChild(dayCol);
                    }
                    header.appendChild(daysContainer); grid.appendChild(header);
                    const body = document.createElement('div'); body.className = "flex flex-1 overflow-y-auto custom-scrollbar relative";
                    const taskList = document.createElement('div'); taskList.className = "w-64 shrink-0 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 z-10";
                    const timeline = document.createElement('div'); timeline.className = "flex relative overflow-x-auto custom-scrollbar bg-slate-50/30 dark:bg-slate-800/20"; timeline.style.width = `${daysInMonth * dayWidth}px`;
                    const bgGrid = document.createElement('div'); bgGrid.className = "absolute inset-0 flex pointer-events-none";
                    for (let i = 1; i <= daysInMonth; i++) { const line = document.createElement('div'); line.style.width = `${dayWidth}px`; line.className = "shrink-0 border-r border-slate-100 dark:border-slate-800/50 h-full"; bgGrid.appendChild(line); }
                    timeline.appendChild(bgGrid);
                    const allEvents = Store.getFilteredEvents(); const eventsInMonth = allEvents.filter(ev => { const start = new Date(ev.dateStr); let end = start; if (ev.deadline) end = new Date(ev.deadline.date); const monthStart = new Date(year, month, 1); const monthEnd = new Date(year, month, daysInMonth); return start <= monthEnd && end >= monthStart; });
                    eventsInMonth.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
                    eventsInMonth.forEach(ev => {
                        const rowTitle = document.createElement('div'); rowTitle.className = "h-10 px-4 flex items-center border-b border-slate-100 dark:border-slate-800 text-xs font-bold text-slate-700 dark:text-slate-300 truncate hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-colors";
                        rowTitle.innerHTML = `<span class="truncate">${Utils.escapeHtml(ev.title)}</span>`; rowTitle.onclick = () => App.events.openModal(new Date(ev.dateStr), ev); taskList.appendChild(rowTitle);
                        const rowTrack = document.createElement('div'); rowTrack.className = "h-10 relative w-full border-b border-transparent group";
                        const startObj = new Date(ev.dateStr); let endObj = ev.deadline ? new Date(ev.deadline.date) : new Date(ev.dateStr); if (endObj < startObj) endObj = startObj;
                        let renderStart = startObj.getDate(); let renderEnd = endObj.getDate(); let isStartCut = false; let isEndCut = false;
                        if (startObj.getMonth() < month || startObj.getFullYear() < year) { renderStart = 1; isStartCut = true; } else if (startObj.getMonth() > month || startObj.getFullYear() > year) { return; }
                        if (endObj.getMonth() > month || endObj.getFullYear() > year) { renderEnd = daysInMonth; isEndCut = true; }
                        const durationDays = renderEnd - renderStart + 1; const leftPos = (renderStart - 1) * dayWidth; const widthPx = durationDays * dayWidth - 4;
                        let barColor = "bg-rose-500"; if (ev.completed) barColor = "bg-green-500 opacity-60"; else if (ev.overdue) barColor = "bg-red-500"; else if (ev.pendingReview) barColor = "bg-amber-400"; else if (Store.session.activeTeamId === 'personal') barColor = "bg-indigo-500";
                        const bar = document.createElement('div'); bar.className = `absolute top-2 h-6 rounded-md shadow-sm text-[10px] text-white flex items-center px-2 cursor-pointer hover:brightness-110 transition-all ${barColor}`;
                        bar.style.left = `${leftPos + 2}px`; bar.style.width = `${widthPx}px`;
                        if (durationDays > 1) { bar.innerHTML = `<span class="truncate w-full font-bold">${isStartCut ? '‚Üê ' : ''}${Utils.escapeHtml(ev.title)}${isEndCut ? ' ‚Üí' : ''}</span>`; }
                        bar.onclick = () => App.events.openModal(new Date(ev.dateStr), ev); bar.title = `${ev.title} (${ev.dateStr} - ${ev.deadline ? ev.deadline.date : ev.dateStr})`;
                        rowTrack.appendChild(bar); timeline.appendChild(rowTrack);
                    });
                    const scrollSync = document.createElement('div'); scrollSync.className = "flex-1 overflow-x-auto custom-scrollbar"; scrollSync.onscroll = (e) => { daysContainer.style.transform = `translateX(-${e.target.scrollLeft}px)`; };
                    scrollSync.appendChild(timeline); body.appendChild(taskList); body.appendChild(scrollSync); grid.appendChild(body);
                },

                renderMonth(grid) {
                    const d = Store.session.currentDate;
                    document.getElementById('current-date-display').innerText = `${this.MONTHS[d.getMonth()]} ${d.getFullYear()}`;

                    // RESPONSIVE CHANGE: grid-cols-1 for mobile, grid-cols-7 for desktop
                    grid.className += " grid grid-cols-1 md:grid-cols-7 gap-4 pb-10";

                    const fragment = document.createDocumentFragment();
                    ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(day => {
                        const el = document.createElement('div');
                        // Hide weekday headers on mobile
                        el.className = 'hidden md:block text-center text-[10px] font-black text-slate-400 pb-4 uppercase tracking-widest';
                        el.innerText = day;
                        fragment.appendChild(el);
                    });

                    const year = d.getFullYear(), month = d.getMonth();
                    const firstDayIndex = new Date(year, month, 1).getDay();
                    const shiftedIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    // Spacer divs hidden on mobile
                    for (let x = 0; x < shiftedIndex; x++) {
                        const spacer = document.createElement('div');
                        spacer.className = "hidden md:block";
                        fragment.appendChild(spacer);
                    }

                    const allEvents = Store.getFilteredEvents();
                    const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];

                    for (let i = 1; i <= daysInMonth; i++) {
                        const dateObj = new Date(year, month, i);
                        const isToday = Utils.areDatesEqual(dateObj, new Date());
                        const dayName = dayNames[dateObj.getDay()];

                        const cell = document.createElement('div');
                        // Responsive height: auto on mobile to fit content, fixed min-height on desktop
                        cell.className = `bg-white dark:bg-slate-900 rounded-[1.5rem] border ${isToday ? 'border-rose-500 ring-4 ring-rose-500/10' : 'border-slate-100 dark:border-slate-800'} p-3 min-h-[100px] md:min-h-[140px] shadow-sm hover:border-rose-400 hover:shadow-lg hover:-translate-y-1 cursor-pointer transition-all relative group overflow-hidden flex flex-col`;

                        cell.ondragover = (e) => App.drag.handleDragOver(e);
                        cell.ondragleave = (e) => App.drag.handleDragLeave(e);
                        cell.ondrop = (e) => App.drag.handleDrop(e, dateObj, null);

                        cell.onclick = () => App.events.openModal(dateObj);

                        // Responsive header inside cell
                        cell.innerHTML = `
                            <div class="flex justify-between items-baseline mb-2">
                                <span class="text-sm font-black ${isToday ? 'text-rose-500' : 'text-slate-300 dark:text-slate-700'}">${i}</span>
                                <span class="md:hidden text-[10px] uppercase font-bold text-slate-400">${dayName}</span>
                            </div>
                        `;

                        const dayEvents = allEvents.filter(e => Utils.isEventVisible(e, dateObj));
                        dayEvents.sort((a,b) => a.time.localeCompare(b.time));
                        dayEvents.forEach(ev => cell.appendChild(this.createEventCard(ev, dateObj)));
                        fragment.appendChild(cell);
                    }
                    grid.appendChild(fragment);
                },

                renderWeek(grid) {
                    const d = Store.session.currentDate;
                    const startOfWeek = Utils.getWeekStart(d);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 6);

                    document.getElementById('current-date-display').innerText = `${startOfWeek.getDate()} ${this.MONTHS[startOfWeek.getMonth()].substr(0,3)} - ${endOfWeek.getDate()} ${this.MONTHS[endOfWeek.getMonth()].substr(0,3)} ${endOfWeek.getFullYear()}`;

                    // Make Week view scrollable horizontally on mobile
                    grid.className += " overflow-x-auto";

                    // Container for the grid to ensure min-width on mobile
                    const container = document.createElement('div');
                    container.className = "grid grid-cols-[50px_repeat(7,1fr)] gap-0 border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden bg-white dark:bg-slate-900 shadow-sm min-w-[800px] md:min-w-0";

                    container.appendChild(document.createElement('div'));
                    for (let i = 0; i < 7; i++) {
                        const curr = new Date(startOfWeek);
                        curr.setDate(curr.getDate() + i);
                        const isToday = Utils.areDatesEqual(curr, new Date());
                        const head = document.createElement('div');

                        if(isToday) {
                            head.className = "text-center py-4 border-b border-l border-rose-500 bg-rose-500 text-white";
                            head.innerHTML = `<div class="text-[10px] font-black text-rose-200 uppercase">${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'][i]}</div><div class="text-xl font-black text-white">${curr.getDate()}</div>`;
                        } else {
                            head.className = "text-center py-4 border-b border-l border-slate-100 dark:border-slate-800";
                            head.innerHTML = `<div class="text-[10px] font-black text-slate-400 uppercase">${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'][i]}</div><div class="text-xl font-black text-slate-700 dark:text-slate-300">${curr.getDate()}</div>`;
                        }
                        container.appendChild(head);
                    }

                    const allEvents = Store.getFilteredEvents();

                    for (let hour = 0; hour < 24; hour++) {
                        const timeLabel = document.createElement('div');
                        timeLabel.className = "text-[10px] font-bold text-slate-400 text-right pr-2 pt-2 border-b border-slate-100 dark:border-slate-800 h-24";
                        timeLabel.innerText = `${hour}:00`;
                        container.appendChild(timeLabel);

                        for (let day = 0; day < 7; day++) {
                            const curr = new Date(startOfWeek);
                            curr.setDate(curr.getDate() + day);

                            const cell = document.createElement('div');
                            cell.className = "border-b border-l border-slate-100 dark:border-slate-800 h-24 relative hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors p-1 overflow-y-auto custom-scrollbar";

                            cell.ondragover = (e) => App.drag.handleDragOver(e);
                            cell.ondragleave = (e) => App.drag.handleDragLeave(e);
                            cell.ondrop = (e) => App.drag.handleDrop(e, curr, `${String(hour).padStart(2,'0')}:00`);

                            cell.onclick = () => {
                                const targetDate = new Date(curr);
                                App.events.openModal(targetDate, null, `${String(hour).padStart(2,'0')}:00`);
                            };

                            const hourEvents = allEvents.filter(e => {
                                const isVisible = Utils.isEventVisible(e, curr);
                                const eHour = parseInt(e.time.split(':')[0]);
                                return isVisible && eHour === hour;
                            });

                            hourEvents.forEach(ev => cell.appendChild(this.createEventCard(ev, curr)));
                            container.appendChild(cell);
                        }
                    }
                    grid.appendChild(container);
                },

                renderDay(grid) {
                    const d = Store.session.currentDate;
                    document.getElementById('current-date-display').innerText = `${d.getDate()} ${this.MONTHS[d.getMonth()]} ${d.getFullYear()}`;
                    grid.className += " max-w-3xl mx-auto bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 overflow-hidden";

                    const isToday = Utils.areDatesEqual(d, new Date());
                    const head = document.createElement('div');
                    const dayName = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'][d.getDay()];

                    if (isToday) {
                        head.className = "p-6 border-b border-rose-500 bg-rose-500 flex justify-between items-center";
                        head.innerHTML = `<div><span class="text-3xl font-black text-white">${d.getDate()}</span><span class="text-xl font-bold text-white uppercase ml-2 hidden md:inline">${dayName}</span><span class="text-lg font-bold text-white uppercase ml-2 md:hidden">${dayName.substr(0,3)}</span></div><span class="text-xs font-black uppercase text-rose-200 tracking-widest border border-rose-200 rounded px-2 py-1">–°–µ–≥–æ–¥–Ω—è</span>`;
                    } else {
                        head.className = "p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center";
                        head.innerHTML = `<div><span class="text-3xl font-black text-rose-500">${d.getDate()}</span><span class="text-xl font-bold text-slate-500 uppercase ml-2 hidden md:inline">${dayName}</span><span class="text-lg font-bold text-slate-500 uppercase ml-2 md:hidden">${dayName.substr(0,3)}</span></div>`;
                    }
                    grid.appendChild(head);

                    const content = document.createElement('div');
                    content.className = "grid grid-cols-[60px_1fr] custom-scrollbar h-[calc(100vh-250px)] md:h-[600px] overflow-y-auto relative";

                    const allEvents = Store.getFilteredEvents();

                    for (let hour = 0; hour < 24; hour++) {
                         const timeDiv = document.createElement('div');
                         timeDiv.className = "text-xs font-bold text-slate-400 text-center pt-4 border-b border-r border-slate-100 dark:border-slate-800 min-h-[80px]";
                         timeDiv.innerText = `${hour}:00`;

                         const slotDiv = document.createElement('div');
                         slotDiv.className = "border-b border-slate-100 dark:border-slate-800 min-h-[80px] p-2 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors relative";

                         slotDiv.ondragover = (e) => App.drag.handleDragOver(e);
                         slotDiv.ondragleave = (e) => App.drag.handleDragLeave(e);
                         slotDiv.ondrop = (e) => App.drag.handleDrop(e, d, `${String(hour).padStart(2,'0')}:00`);

                         slotDiv.onclick = () => App.events.openModal(d, null, `${String(hour).padStart(2,'0')}:00`);

                         const hourEvents = allEvents.filter(e => {
                            const isVisible = Utils.isEventVisible(e, d);
                            const eHour = parseInt(e.time.split(':')[0]);
                            return isVisible && eHour === hour;
                        });

                        hourEvents.forEach(ev => {
                            const card = this.createEventCard(ev, d);
                            card.className = card.className.replace("text-[10px]", "text-sm").replace("mb-1", "mb-2");
                            card.classList.add("py-2", "px-3");
                            slotDiv.appendChild(card);
                        });

                        content.appendChild(timeDiv);
                        content.appendChild(slotDiv);
                    }
                    grid.appendChild(content);
                },

                renderYear(grid) {
                    const year = Store.session.currentDate.getFullYear();
                    document.getElementById('current-date-display').innerText = `${year}`;
                    grid.className += " grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pb-10"; // Responsive Columns

                    const allEvents = Store.getFilteredEvents();

                    for(let m=0; m<12; m++) {
                        const monthContainer = document.createElement('div');
                        monthContainer.className = "bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 hover:shadow-lg transition-all relative hover:border-rose-400";
                        monthContainer.onclick = () => { Store.session.currentDate.setMonth(m); this.switchView('month'); };

                        const title = document.createElement('h4');
                        title.className = "text-rose-500 font-black uppercase text-xs mb-2 tracking-widest cursor-pointer";
                        title.innerText = this.MONTHS[m];
                        monthContainer.appendChild(title);

                        const miniGrid = document.createElement('div');
                        miniGrid.className = "grid grid-cols-7 gap-1 text-center";

                        const firstDay = new Date(year, m, 1).getDay();
                        const shift = firstDay === 0 ? 6 : firstDay - 1;
                        for(let i=0; i<shift; i++) miniGrid.appendChild(document.createElement('div'));

                        const days = new Date(year, m+1, 0).getDate();
                        for(let d=1; d<=days; d++) {
                            const dayEl = document.createElement('div');
                            const dateObj = new Date(year, m, d);
                            const count = allEvents.filter(e => Utils.isEventVisible(e, dateObj)).length;
                            let cellClass = "text-[9px] w-6 h-6 flex items-center justify-center mx-auto rounded-full cursor-pointer transition-all hover:scale-125 hover:bg-slate-100 dark:hover:bg-slate-700 ";
                            let colorClass = "text-slate-400 dark:text-slate-500";

                            if (count > 0) colorClass = "bg-rose-100 text-rose-600 font-bold";
                            if (count > 2) colorClass = "bg-rose-500 text-white font-bold";
                            if (Utils.areDatesEqual(dateObj, new Date())) colorClass = "border border-rose-500 text-rose-500 font-black";

                            dayEl.className = cellClass + colorClass;
                            dayEl.innerText = d;
                            dayEl.onclick = (e) => { e.stopPropagation(); Store.session.currentDate = new Date(year, m, d); this.switchView('day'); };
                            miniGrid.appendChild(dayEl);
                        }
                        monthContainer.appendChild(miniGrid);
                        grid.appendChild(monthContainer);
                    }
                }
            },
            teams: {
                contextTeamId: null,
                contextMemberId: null,

                switch(id) { Store.session.activeTeamId = id; localStorage.setItem('pin_v2_active_team', id); document.getElementById('team-dropdown').classList.add('hidden'); App.ui.refresh(); },
                create() {
                    const name = document.getElementById('new-team-name').value.trim();
                    if(!name) return App.ui.showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", "alert");
                    const newTeam = { id: Utils.generateId(), name: name, ownerId: Store.session.user.id, members: [Store.session.user.id] };
                    if(!Store.data.teams) Store.data.teams = [];
                    Store.data.teams.push(newTeam);
                    Store.save();
                    App.ui.closeModal('modal-create-team');
                    this.switch(newTeam.id);
                },
                invite() {
                    const loginOrId = document.getElementById('invite-login').value.trim();
                    const userToInvite = (Store.data.users || []).find(u =>
                        u.name.toLowerCase() === loginOrId.toLowerCase() ||
                        (u.uid && u.uid === loginOrId.toUpperCase())
                    );
                    const team = Store.getActiveTeam();
                    if (!userToInvite) return App.ui.showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω", "alert");
                    if (team.members.includes(userToInvite.id)) return App.ui.showToast("–£–∂–µ –≤ –∫–æ–º–∞–Ω–¥–µ", "info");
                    team.members.push(userToInvite.id);
                    App.notifications.add(userToInvite.id, `–í–∞—Å –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∫–æ–º–∞–Ω–¥—É "${team.name}"`, 'info');
                    Store.save(); App.ui.closeModal('modal-invite'); App.ui.showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userToInvite.name} –¥–æ–±–∞–≤–ª–µ–Ω`, "success");
                },
                showContextMenu(e, id) {
                    e.preventDefault(); this.contextTeamId = id; this.closeUserContextMenu();
                    const team = Store.data.teams.find(t => t.id === id); if (!team) return;
                    const isOwner = team.ownerId === Store.session.user.id;
                    const btnDelete = document.getElementById('ctx-btn-delete-team'); const btnLeave = document.getElementById('ctx-btn-leave-team');
                    if (isOwner) { btnDelete.classList.remove('hidden'); btnDelete.classList.add('flex'); btnLeave.classList.add('hidden'); btnLeave.classList.remove('flex'); }
                    else { btnDelete.classList.add('hidden'); btnDelete.classList.remove('flex'); btnLeave.classList.remove('hidden'); btnLeave.classList.add('flex'); }
                    const menu = document.getElementById('team-context-menu'); menu.classList.remove('hidden'); menu.style.left = `${e.clientX}px`; menu.style.top = `${e.clientY}px`;
                },
                closeContextMenu() { const menu = document.getElementById('team-context-menu'); if(menu) menu.classList.add('hidden'); this.contextTeamId = null; },
                delete() {
                    if(!this.contextTeamId) return;
                    const team = Store.data.teams.find(t => t.id === this.contextTeamId);
                    if (team.ownerId !== Store.session.user.id) { App.ui.showToast("–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É", "alert"); this.closeContextMenu(); return; }
                    if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É "${team ? team.name : ''}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;
                    const id = this.contextTeamId; Store.data.teams = Store.data.teams.filter(t => t.id !== id); Store.data.events = Store.data.events.filter(e => e.teamId !== id);
                    Store.save();
                    if (Store.session.activeTeamId === id) { this.switch('personal'); } else { App.ui.refresh(); }
                    this.closeContextMenu(); App.ui.showToast('–ö–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                },
                leave() {
                    if(!this.contextTeamId) return;
                    const team = Store.data.teams.find(t => t.id === this.contextTeamId);
                    if(!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–∞–Ω–¥—É "${team.name}"?`)) return;
                    team.members = team.members.filter(uid => uid !== Store.session.user.id);
                    Store.save();
                    if (Store.session.activeTeamId === this.contextTeamId) { this.switch('personal'); } else { App.ui.refresh(); }
                    this.closeContextMenu(); App.ui.showToast('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–∞–Ω–¥—É', 'info');
                },
                showUserContextMenu(e, userId) {
                    e.preventDefault(); this.contextMemberId = userId; this.closeContextMenu();
                    const menu = document.getElementById('user-context-menu'); menu.classList.remove('hidden'); menu.style.left = `${e.clientX}px`; menu.style.top = `${e.clientY}px`;
                    const team = Store.getActiveTeam(); const isOwner = team && team.ownerId === Store.session.user.id;
                    const btnRemove = document.getElementById('btn-remove-user'); btnRemove.style.display = isOwner ? 'flex' : 'none';
                },
                closeUserContextMenu() { const menu = document.getElementById('user-context-menu'); if(menu) menu.classList.add('hidden'); this.contextMemberId = null; },
                viewUserProfile() {
                    if(!this.contextMemberId) return;
                    const user = (Store.data.users || []).find(u => u.id === this.contextMemberId); if(!user) return;
                    document.getElementById('view-profile-avatar').src = user.avatar; document.getElementById('view-profile-name').innerText = user.name; document.getElementById('view-profile-uid').innerText = `ID: ${user.uid || '---'}`;
                    this.closeUserContextMenu(); App.ui.openModal('modal-view-profile');
                },
                removeMember() {
                    if(!this.contextMemberId) return;
                    const team = Store.getActiveTeam(); if(!team) return;
                    if (team.ownerId !== Store.session.user.id) return;
                    const userToRemove = (Store.data.users || []).find(u => u.id === this.contextMemberId);
                    if(!confirm(`–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${userToRemove ? userToRemove.name : ''} –∏–∑ –∫–æ–º–∞–Ω–¥—ã?`)) return;
                    team.members = team.members.filter(id => id !== this.contextMemberId);
                    Store.save(); App.ui.refresh(); this.closeUserContextMenu(); App.ui.showToast('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω', 'success');
                }
            },
            events: {
                toggleDeadlineUI() {
                    const hasDeadline = document.getElementById('event-has-deadline').checked;
                    const inputs = document.getElementById('deadline-inputs');
                    if(hasDeadline) { inputs.classList.remove('hidden'); inputs.classList.add('grid'); }
                    else { inputs.classList.add('hidden'); inputs.classList.remove('grid'); }
                },
                setRecurrence(type) {
                    document.getElementById('event-recurrence').value = type;
                    ['none', 'daily', 'weekly'].forEach(t => {
                        const btn = document.getElementById(`rec-btn-${t}`);
                        if(t === type) btn.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white";
                        else btn.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
                    });
                },
                handleFileUpload(input) {
                    const file = input.files[0];
                    if(!file) return;
                    if(file.size > 1.5 * 1024 * 1024) { input.value = ''; return App.ui.showToast("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π", "alert"); }
                    const r = new FileReader();
                    r.onload = e => { Store.session.tempFile = { name: file.name, data: e.target.result }; this.updateFileUI(); };
                    r.readAsDataURL(file);
                },
                removeFile() { Store.session.tempFile = null; document.getElementById('event-file-input').value = ''; this.updateFileUI(); },
                updateFileUI() {
                    const file = Store.session.tempFile;
                    if (file) {
                        document.getElementById('file-upload-ui').classList.add('hidden');
                        document.getElementById('file-display-ui').classList.remove('hidden');
                        document.getElementById('file-name-display').innerText = file.name;
                        const link = document.getElementById('file-download-link');
                        link.href = file.data; link.download = file.name;
                    } else {
                        document.getElementById('file-upload-ui').classList.remove('hidden');
                        document.getElementById('file-display-ui').classList.add('hidden');
                    }
                },
                openModal(dateObj = null, existing = null, timePreselect = '12:00') {
                    Store.session.currentEventId = existing ? existing.id : null;
                    Store.session.contextDateStr = Utils.formatDateForInput(existing ? (dateObj || new Date(existing.dateStr)) : (dateObj || Store.session.currentDate));

                    document.getElementById('modal-event-title').innerText = existing ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" : "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞";

                    const team = Store.getActiveTeam();
                    const userId = Store.session.user.id;
                    const isTeamMode = Store.session.activeTeamId !== 'personal';
                    const canEdit = !existing || !isTeamMode || (team && team.ownerId === userId) || (existing && existing.creatorId === userId);

                    document.getElementById('btn-delete-event').classList.toggle('hidden', !existing || !canEdit);

                    const inputsToLock = ['event-name', 'event-full-date', 'event-time', 'event-has-deadline', 'deadline-date', 'deadline-time', 'event-file-input'];
                    inputsToLock.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = !canEdit; });

                    const blocksToLock = ['recurrence-block', 'participants-block', 'file-upload-ui'];
                    blocksToLock.forEach(id => { const el = document.getElementById(id); if(el) { el.style.pointerEvents = canEdit ? 'auto' : 'none'; el.style.opacity = canEdit ? '1' : '0.6'; } });

                    document.getElementById('event-name').value = existing ? existing.title : '';
                    document.getElementById('event-full-date').value = Store.session.contextDateStr;
                    document.getElementById('event-time').value = existing ? existing.time : timePreselect;

                    const hasDeadline = existing && existing.deadline;
                    document.getElementById('event-has-deadline').checked = !!hasDeadline;
                    document.getElementById('deadline-date').value = hasDeadline ? existing.deadline.date : Store.session.contextDateStr;
                    document.getElementById('deadline-time').value = hasDeadline ? existing.deadline.time : '23:59';
                    this.toggleDeadlineUI();

                    const recBlock = document.getElementById('recurrence-block');
                    if (Store.session.activeTeamId === 'personal') { recBlock.classList.remove('hidden'); this.setRecurrence(existing && existing.recurrence ? existing.recurrence : 'none'); }
                    else { recBlock.classList.add('hidden'); this.setRecurrence('none'); }

                    const btn = document.getElementById('btn-status-toggle');
                    let initialState = 'todo';
                    if (existing) {
                        const isDone = Utils.isEventCompleted(existing, Store.session.contextDateStr);
                        if (isDone) initialState = 'done'; else if (existing.pendingReview) initialState = 'review';
                    }
                    this.renderStatusBtn(btn, initialState);
                    btn.style.pointerEvents = 'auto'; btn.style.opacity = '1';

                    Store.session.tempFile = existing && existing.file ? existing.file : null; this.updateFileUI();
                    if (!canEdit && Store.session.tempFile) { const removeFileBtn = document.querySelector('#file-display-ui button'); if(removeFileBtn) removeFileBtn.style.display = 'none'; }
                    else { const removeFileBtn = document.querySelector('#file-display-ui button'); if(removeFileBtn) removeFileBtn.style.display = 'block'; }

                    const pBlock = document.getElementById('participants-block');
                    if (Store.session.activeTeamId === 'personal') { pBlock.style.display = 'none'; }
                    else {
                        pBlock.style.display = 'block'; const team = Store.getActiveTeam();
                        const members = (Store.data.users || []).filter(u => team.members.includes(u.id));
                        const assigned = existing ? (existing.assignees || []) : [];
                        document.getElementById('modal-users').innerHTML = members.map(u => `
                             <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-colors group">
                                <div class="relative flex items-center"><input type="checkbox" name="assignee" value="${u.id}" ${assigned.includes(u.id) ? 'checked' : ''} class="peer appearance-none w-5 h-5 border-2 border-slate-300 dark:border-slate-600 rounded checked:bg-rose-500 checked:border-rose-500 transition-colors" ${!canEdit ? 'disabled' : ''}><svg class="absolute w-3 h-3 text-white hidden peer-checked:block pointer-events-none left-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
                                <img src="${u.avatar}" class="w-7 h-7 rounded-full object-cover"><span class="text-xs font-bold text-slate-700 dark:text-slate-300 group-hover:text-rose-500 transition-colors">${u.name}</span>
                            </label>`).join('');
                    }
                    App.ui.openModal('modal-event');
                },
                toggleStatusUI() {
                    const btn = document.getElementById('btn-status-toggle'); const currentState = btn.dataset.state || 'todo';
                    const team = Store.getActiveTeam(); const isBoss = team && team.ownerId === Store.session.user.id; const isPersonal = !team;
                    let nextState = 'todo';
                    if (isPersonal) { nextState = currentState === 'done' ? 'todo' : 'done'; }
                    else if (isBoss) { if (currentState === 'done') nextState = 'todo'; else nextState = 'done'; }
                    else { if (currentState === 'todo') nextState = 'review'; else if (currentState === 'review') nextState = 'todo'; else if (currentState === 'done') nextState = 'review'; }
                    this.renderStatusBtn(btn, nextState);
                },
                renderStatusBtn(btn, state) {
                    btn.dataset.state = state;
                    if (state === 'done') { btn.innerText = "–í–´–ü–û–õ–ù–ï–ù–û ‚úì"; btn.className = "px-4 py-2 rounded-lg text-xs font-bold transition-all bg-green-500 text-white shadow-lg shadow-green-500/30"; }
                    else if (state === 'review') { btn.innerText = "–ù–ê –ü–†–û–í–ï–†–ö–ï ‚è≥"; btn.className = "px-4 py-2 rounded-lg text-xs font-bold transition-all bg-amber-400 text-white shadow-lg shadow-amber-400/30"; }
                    else { btn.innerText = "–í –ü—Ä–æ—Ü–µ—Å—Å–µ"; btn.className = "px-4 py-2 rounded-lg text-xs font-bold transition-all bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-300 hover:bg-slate-300"; }
                },
                save() {
                    const title = document.getElementById('event-name').value.trim(); const dateStr = document.getElementById('event-full-date').value;
                    const time = document.getElementById('event-time').value; const recurrence = document.getElementById('event-recurrence').value;
                    if(!title || !dateStr || !time) return App.ui.showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", "alert");
                    const hasDeadline = document.getElementById('event-has-deadline').checked;
                    const deadlineData = hasDeadline ? { date: document.getElementById('deadline-date').value, time: document.getElementById('deadline-time').value } : null;
                    const statusState = document.getElementById('btn-status-toggle').dataset.state; const isDone = statusState === 'done'; const isReview = statusState === 'review';
                    const assignees = Store.session.activeTeamId === 'personal' ? [] : Array.from(document.querySelectorAll('input[name="assignee"]:checked')).map(c => parseInt(c.value));
                    let existingEvent = Store.session.currentEventId ? Store.data.events.find(e => e.id === Store.session.currentEventId) : null;
                    let completed = existingEvent ? existingEvent.completed : false; let completedDates = existingEvent ? (existingEvent.completedDates || []) : [];
                    const ctxDate = Store.session.contextDateStr || dateStr;
                    const team = Store.getActiveTeam();

                    // RATING LOGIC
                    if (team && team.ownerId === Store.session.user.id && isDone) {
                        const wasCompleted = existingEvent && Utils.isEventCompleted(existingEvent, ctxDate);
                        if (!wasCompleted) {
                            if (!team.ratings) team.ratings = {};
                            assignees.forEach(userId => {
                                const currentScore = team.ratings[userId] || 0; team.ratings[userId] = currentScore + 100;
                                if (userId !== Store.session.user.id) { App.notifications.add(userId, `üèÜ –í—ã –ø–æ–ª—É—á–∏–ª–∏ +100 —Ä–µ–π—Ç–∏–Ω–≥–∞ –≤ –∫–æ–º–∞–Ω–¥–µ "${team.name}"!`, 'success'); }
                            });
                            App.ui.showToast("–†–µ–π—Ç–∏–Ω–≥ –Ω–∞—á–∏—Å–ª–µ–Ω!", "success");
                        }
                    }

                    if (recurrence !== 'none') { if (isDone) { if (!completedDates.includes(ctxDate)) completedDates.push(ctxDate); } else { completedDates = completedDates.filter(d => d !== ctxDate); } } else { completed = isDone; }
                    if (isReview && (!existingEvent || !existingEvent.pendingReview)) { if (team && team.ownerId !== Store.session.user.id) { App.notifications.add(team.ownerId, `–ó–∞–¥–∞—á–∞ "${title}" –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏`, 'info'); } }
                    const eventData = {
                        id: Store.session.currentEventId || Utils.generateId(), title, dateStr, time, completed, completedDates, recurrence, overdue: false, pendingReview: isReview, deadline: deadlineData,
                        context: Store.session.activeTeamId === 'personal' ? 'personal' : 'team', teamId: Store.session.activeTeamId, creatorId: Store.session.user.id, assignees: assignees, file: Store.session.tempFile
                    };
                    if (Store.session.currentEventId) { const idx = Store.data.events.findIndex(e => e.id === Store.session.currentEventId); if(idx !== -1) Store.data.events[idx] = eventData; }
                    else { Store.data.events.push(eventData); }
                    Store.save(); App.ui.closeModal('modal-event');
                },
                delete() {
                    if(!Store.session.currentEventId) return;
                    if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) return;
                    Store.data.events = Store.data.events.filter(e => e.id !== Store.session.currentEventId);
                    Store.save(); App.ui.closeModal('modal-event');
                }
            },
            notifications: {
                add(userId, msg, type = 'info') {
                    if(!Store.data.notifications) Store.data.notifications = [];
                    Store.data.notifications.unshift({ id: Utils.generateId(), to: userId, msg: msg, type: type, read: false, date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
                    Store.save();
                },
                updateBadge() {
                    const myNotifs = (Store.data.notifications || []).filter(n => n.to === Store.session.user.id && !n.read);
                    const badge = document.getElementById('notif-badge'); if (myNotifs.length > 0) badge.classList.add('active'); else badge.classList.remove('active');
                },
                clearAll() { Store.data.notifications = (Store.data.notifications || []).filter(n => n.to !== Store.session.user.id); Store.save(); this.updateBadge(); document.getElementById('notif-dropdown').classList.add('hidden'); },
                checkDeadlines() {
                    const now = new Date(); let changed = false;
                    (Store.data.events || []).forEach(ev => {
                        if (ev.completed || ev.overdue) return;
                        let targetDate; if (ev.deadline) targetDate = new Date(ev.deadline.date + 'T' + ev.deadline.time); else targetDate = new Date(ev.dateStr + 'T' + ev.time);
                        if (now > targetDate) { ev.overdue = true; changed = true; App.notifications.add(ev.creatorId, `–ó–∞–¥–∞—á–∞ "${ev.title}" –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞!`, 'alert'); }
                    });
                    if (changed) { Store.save(); App.calendar.render(); }
                }
            }
        };

        initApp();

        window.addEventListener('click', (e) => {
            const btn = document.getElementById('view-btn'); const drop = document.getElementById('view-dropdown');
            if (btn && drop && !btn.contains(e.target) && !drop.contains(e.target)) { App.ui.closeViewDropdown(); }
            App.teams.closeContextMenu(); App.teams.closeUserContextMenu();
        });
    </script>
</body>
</html>